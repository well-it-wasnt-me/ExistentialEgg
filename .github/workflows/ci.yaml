name: CI, Docs, and SemVer

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build (acts as test gate)
        run: pio run

  docs:
    name: Generate Doxygen Docs
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Generate docs
        run: |
          mkdir -p docs/theme
          cat > docs/theme/doxygen-custom.css <<'EOF'
          :root {
            --primary-color: #0f766e;
            --primary-light-color: #14b8a6;
            --page-background-color: #f5f7f9;
            --side-nav-background: #e8eef2;
            --code-background: #eef3f7;
          }
          .title {
            letter-spacing: 0.02em;
          }
          #projectbrief {
            font-style: italic;
          }
          .contents p {
            line-height: 1.5;
          }
          EOF

          cat > Doxyfile.ci <<'EOF'
          PROJECT_NAME           = "ExistentialEgg"
          PROJECT_BRIEF          = "A tiny pet simulator that still judges your life choices."
          OUTPUT_DIRECTORY       = docs
          GENERATE_HTML          = YES
          GENERATE_LATEX         = NO
          RECURSIVE              = YES
          INPUT                  = src README.md
          FILE_PATTERNS          = *.h *.cpp *.md
          EXTRACT_ALL            = YES
          WARN_IF_UNDOCUMENTED   = NO
          HTML_COLORSTYLE        = LIGHT
          HTML_DYNAMIC_SECTIONS  = YES
          GENERATE_TREEVIEW      = YES
          FULL_SIDEBAR           = YES
          HTML_EXTRA_STYLESHEET  = docs/theme/doxygen-custom.css
          QUIET                  = YES
          EOF

          doxygen Doxyfile.ci

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: doxygen-html
          path: docs/html
          if-no-files-found: error

      - name: Upload GitHub Pages artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/html

  deploy-pages:
    name: Deploy Docs to GitHub Pages
    runs-on: ubuntu-latest
    needs: docs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4

  semver:
    name: Semantic Version Tag
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate semantic version
        id: semver
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "BREAKING CHANGE"
          minor_pattern: "feat"
          search_commit_body: true

      - name: Create and push tag
        env:
          TAG: ${{ steps.semver.outputs.version_tag }}
        run: |
          git fetch --tags
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag "$TAG"
          git push origin "$TAG"

      - name: Report version
        run: |
          echo "Calculated version: ${{ steps.semver.outputs.version }}"
          echo "Tag: ${{ steps.semver.outputs.version_tag }}"
